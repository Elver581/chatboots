const { createBot, createProvider, createFlow, addKeyword, EVENTS } = require('@bot-whatsapp/bot');
const QRPortalWeb = require('@bot-whatsapp/portal');
const BaileysProvider = require('@bot-whatsapp/provider/baileys');
const MockAdapter = require('@bot-whatsapp/database/mock');

// Ruta del catÃ¡logo en tu proyecto
const catalogoURL = 'https://setasplast.com.co/assets/SetasPlastBrochureEmpresarial-eawpt2g4.pdf'; 

// DuraciÃ³n del timeout en milisegundos (10 minutos)
const timeoutDuration = 10 * 60 * 1000;

// Funciones para cada flujo
const flowAtencionCliente = addKeyword(EVENTS.ACTION)
    .addAnswer("Hola, sigue el enlace haciendo clic en el siguiente botÃ³n:")
    .addAnswer("[ðŸ“² AtenciÃ³n al Cliente](https://api.whatsapp.com/send?phone=573105083525&text=Hola)")
    .addAnswer("Gracias por comunicarte con nosotros. Â¿Puedo ayudarte con algo mÃ¡s?", null, async (ctx, { gotoFlow }) => {
        return gotoFlow(menuFlow); // Mostrar el menÃº automÃ¡ticamente
    });

const flowAreaComercial = addKeyword(EVENTS.ACTION)
    .addAnswer("Ãrea Comercial, sigue el enlace haciendo clic en el siguiente botÃ³n:")
    .addAnswer("[ðŸ’¼ Ãrea Comercial](https://api.whatsapp.com/send?phone=573145719136&text=Hola)")
    .addAnswer("Gracias por comunicarte con el Ã¡rea comercial. Â¿Puedo ayudarte con algo mÃ¡s?", null, async (ctx, { gotoFlow }) => {
        return gotoFlow(menuFlow); // Mostrar el menÃº automÃ¡ticamente
    });

const flowContabilidad = addKeyword(EVENTS.ACTION)
    .addAnswer("Ãrea de Contabilidad, sigue el enlace haciendo clic en el siguiente botÃ³n:")
    .addAnswer("[ðŸ“Š Contabilidad](https://api.whatsapp.com/send?phone=573147302425&text=Hola)")
    .addAnswer("Gracias por comunicarte con el Ã¡rea de contabilidad. Â¿Puedo ayudarte con algo mÃ¡s?", null, async (ctx, { gotoFlow }) => {
        return gotoFlow(menuFlow); // Mostrar el menÃº automÃ¡ticamente
    });

const FlowAdministrativa = addKeyword(EVENTS.ACTION)
    .addAnswer("Ãrea Administrativa, sigue el enlace haciendo clic en el siguiente botÃ³n:")
    .addAnswer("[ðŸ“Š Admistrativa/Tesoreria](https://api.whatsapp.com/send?phone=573134924743&text=Hola)")
    .addAnswer("Gracias por comunicarte con el Ã¡rea Administrativa. Â¿Puedo ayudarte con algo mÃ¡s?", null, async (ctx, { gotoFlow }) => {
        return gotoFlow(menuFlow); // Mostrar el menÃº automÃ¡ticamente
    });

const FlowGestionAmbiental = addKeyword(EVENTS.ACTION)
    .addAnswer("GestiÃ³n Ambiental, accede haciendo clic en el botÃ³n:")
    .addAnswer("[ðŸŒ GestiÃ³n Ambiental](https://api.whatsapp.com/send?phone=573143630641&text=Hola)")
    .addAnswer("Gracias por comunicarte con el Ã¡rea de gestion ambiental. Â¿Puedo ayudarte con algo mÃ¡s?", null, async (ctx, { gotoFlow }) => {
        return gotoFlow(menuFlow); // Mostrar el menÃº automÃ¡ticamente
    });

// Flujo del catÃ¡logo (actualizado para enviar el PDF)
const flowCatalogo = addKeyword(["catÃ¡logo", "catalogo"]) 
    .addAnswer("AquÃ­ puedes ver nuestro catÃ¡logo:")
    .addAnswer([
        {
            media: catalogoURL 
        }
    ]) 
    .addAnswer("Gracias por revisar nuestro catÃ¡logo. Â¿Puedo ayudarte con algo mÃ¡s?", null, async (ctx, { gotoFlow }) => {
        return gotoFlow(menuFlow); // Mostrar el menÃº automÃ¡ticamente
    });

const flowPqr = addKeyword(EVENTS.ACTION)
    .addAnswer("Para consultas, puedes enviarnos un correo haciendo clic en el botÃ³n:")
    .addAnswer("[âœ‰ï¸ Enviar Correo](mailto:elveral100@gmail.com?subject=Consulta&body=Hola,%20tengo%20una%20pregunta.)")
    .addAnswer("Gracias por comunicarte con PQR. Â¿Puedo ayudarte con algo mÃ¡s?", null, async (ctx, { gotoFlow }) => {
        return gotoFlow(menuFlow); // Mostrar el menÃº automÃ¡ticamente
    });

// Flujo principal de bienvenida
const flowPrincipal = addKeyword([
    "hola",  
    "buenos dias", 
    "buenas tardes", 
    "buenas noches", 
    "HOLA",  
    "BUENOS DIAS", 
    "BUENAS TARDES", 
    "BUENAS NOCHES"
])
.addAnswer('ðŸ‘‹ Â¡Hola! Bienvenido a nuestro ChatbotÂ  soy GaiaðŸ¤– tu asesora vitual' ,{
    media:"https://66df26a3417a4a3cbd85c535--iridescent-clafoutis-f96418.netlify.app/assets/guia-r6eU_DZf.webp"
})

.addAnswer(
    [
        'Somos [ SETASPLAST SAS BIC], especializados en la comercializaciÃ³n de productos plÃ¡sticos biodegradables y 100% reciclables ðŸŒ±ðŸŒâœ¨.',
        '',
        'A continuaciÃ³n te mostramos nuestras opciones principales:'
    ], 
    null,
    async (ctx, { gotoFlow }) => {
        return gotoFlow(menuFlow); // Mostrar el menÃº directamente
    }
);

// Flujo para manejar las opciones del menÃº (con cierre de conversaciÃ³n por inactividad)
const menuFlow = addKeyword(["menu", "Menu", "1", "2", "3", "4", "5", "0"]).addAnswer(
    [
        'ðŸŒ Canales de ComunicaciÃ³n',
        '',
        'Te comparto nuestros canales de comunicaciÃ³n para brindarte una mejor atenciÃ³n:',
        '',
        'Selecciona una OpciÃ³n:',
        '',
        '1ï¸âƒ£ Ãrea Comercial',
        '2ï¸âƒ£ Contabilidad',
        '3ï¸âƒ£ Ãrea Administrativa',
        '4ï¸âƒ£ GestiÃ³n Ambiental',
        '5ï¸âƒ£ AtenciÃ³n al Cliente',
        '6ï¸âƒ£ PQR',
        '7ï¸âƒ£ CatÃ¡logo',
        '',
        'âœï¸ Escribe el nÃºmero correspondiente para continuar.'
    ],
    { capture: true },
    async (ctx, { gotoFlow, fallBack, flowDynamic }) => {
        const opcionesValidas = ["1", "2", "3", "4", "5", "6", "7"];

        // Iniciar el temporizador cuando se muestra el menÃº
        let timeoutId = setTimeout(async () => {
            await flowDynamic('ðŸ˜… Ups!!! veo que te ocupaste, por falta de contacto cerrarÃ© la ðŸ’¬ conversaciÃ³n pero, podrÃ¡s retomar cuando lo desees escribiendo la palabra ðŸ‘‰ asesor');
        }, timeoutDuration);

        if (!opcionesValidas.includes(ctx.body)) {
            // Limpiar el temporizador si la respuesta no es vÃ¡lida
            clearTimeout(timeoutId);
            return fallBack("âŒ Respuesta no vÃ¡lida, por favor selecciona una opciÃ³n vÃ¡lida.");
        }

        // Limpiar el temporizador si se selecciona una opciÃ³n vÃ¡lida
        clearTimeout(timeoutId);

        switch (ctx.body) {
            case "1":
                return gotoFlow(flowAreaComercial);
            case "2":
                return gotoFlow(flowContabilidad);
            case "3":
                return gotoFlow(FlowAdministrativa);
            case "4":
                return gotoFlow(FlowGestionAmbiental);
            case "5":
                return gotoFlow(flowAtencionCliente);
            case "6":
                return gotoFlow(flowPqr);
            case "7":
                return gotoFlow(flowCatalogo); 
        }
    }
);

const main = async () => {
    const adapterDB = new MockAdapter();
    const adapterFlow = createFlow([menuFlow, flowAtencionCliente, 
        flowAreaComercial, flowContabilidad, flowCatalogo, flowPqr, flowPrincipal, FlowAdministrativa, FlowGestionAmbiental
    ]);
    const adapterProvider = createProvider(BaileysProvider);

    createBot({
        flow: adapterFlow,
        provider: adapterProvider,
        database: adapterDB,
    });

    QRPortalWeb();
};

main();